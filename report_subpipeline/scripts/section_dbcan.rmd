## Cazymes from dbCAN

`rule dbcan`

```{r dbcan, echo = F, message = F, warning = F, error = T}
# Show data table and make a heatmap for substrates to highlight interpretation


#setwd("~/assemblycomparator2/tests/student");  # DEBUG
df_dbcan_raw = read_tsv(glob_list$dbcan, id = "file", na = "-") %>% #, comment = "#", col_names = c("name", "value")) %>%
    
    # Extract sample name
    mutate(sample = str_extract(file, "results_ac2/samples/(.+)/dbcan/dbcan-sub.hmm.out", group = 1)) %>% 
    relocate(sample) %>% 
    select(-file) %>% 
    
    # Extract coverage (for some reason, the coverage is outputted twice..)
    rename(coverage_raw = Coverage) %>% 
    mutate(Coverage = str_extract(coverage_raw, "^\\d+\\.\\d+") %>% as.numeric()) %>% 
    select(-coverage_raw)



df_dbcan = metadata_translate %>%
    select(index, sample) %>%
    left_join(df_dbcan_raw, by = "sample")


df_dbcan %>% 
    select(-index)  %>% 
    custom_dt("dbcan")


```


*Table `r tableno()`: Overview of dbcan cazyme results. Called using [run_dbcan](https://github.com/linnabrown/run_dbcan).*

```{r dbcan-plot, echo=FALSE, message=F, warning=F, error = T, fig.height = max(1.8, (N*0.2)+1.3), fig.width = 10}
# Heatmap of substrates


# I think a better way, would be to count how many have coverage above 90, and then show those counts.


df_dbcan %>% 

    select(index, sample, substrate = Substrate, coverage = Coverage, dbcan_subfam = `dbCAN subfam`) %>% 
    drop_na(substrate) %>% 
    
    # Some cazymes have substrate "xylan, xylan" and "xylan, xylan, xylan" which doesn't make any sense. Let's collapse unique substrates per cazyme.
    
    rowwise() %>% 
    mutate(
        substrate_split = str_split(substrate, ", "), 
        substrate_unique = substrate_split %>% unique() %>% list(),
        substrate_unique_paste = paste(substrate_unique, collapse = ", ")
    ) %>% 
    

    
    group_by(index, sample, substrate_unique_paste) %>% 
    filter(coverage >= .9) %>% 
    summarize(count = n()) %>% 
    
    
    ggplot(aes(substrate_unique_paste, reorder(sample, desc(index)), fill = count)) + 
    geom_tile() +
    scale_fill_viridis_c() + 
    theme_classic() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + 
    labs(
        x = "substrate", 
        y = "sample"
    )

```

*Fig. `r figno()`: Overview of carbohydrate active enzymes (Cazymes). The count (color) signifies the number of cazymes in each sample, that can degrade each of the listed substrates. *

---